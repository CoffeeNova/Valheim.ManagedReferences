name: Pack Managed References

on:
  push:
    branches:
        - main
    tags:
        - 'v*'
  pull_request:
    branches:
        - main
  # schedule:
    # - cron: '0 */1 * * *'  # every hour
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no Valheim updates'
        required: false
        type: boolean
        default: false

jobs:
  clean:
    runs-on: self-hosted
    steps:
      - name: Clean runner logs
        run: |
          rm -rf $HOME/actions-runner/_diag/pages/*.log || true
        continue-on-error: true
        
  build:
    runs-on: self-hosted
    needs: clean
    env:
      DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
  
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v3.1.11
        with:
          versionSpec: '6.0.x'
      
      - name: Get current build ID
        id: current_build
        run: |
          MANIFEST_FILE="/home/gh-runner/valheim/steamapps/appmanifest_892970.acf"
          if [ -f "$MANIFEST_FILE" ]; then
            CURRENT_BUILD=$(grep -oP '"buildid"\s+"\K[^"]+' "$MANIFEST_FILE" || echo "0")
            echo "current_build=$CURRENT_BUILD" >> $GITHUB_OUTPUT
            echo "Current Valheim build: $CURRENT_BUILD"
          else
            echo "current_build=0" >> $GITHUB_OUTPUT
            echo "No existing installation found"
          fi

      
      - name: Update Valheim
        id: update_valheim
        timeout-minutes: 90
        run: |
          LOG_FILE="/tmp/valheim_update_${{ github.run_number }}.log"
          
          echo "Starting Valheim update at $(date)"
          
          script -q -c "steamcmd \
            +@sSteamCmdForcePlatformType windows \
            +force_install_dir /home/gh-runner/valheim \
            +login ${{ secrets.STEAM_USERNAME }} \
            +app_update 892970 validate \
            +quit" "$LOG_FILE"
          
          EXIT_CODE=$?
          
          echo "Completed at $(date) with exit code: $EXIT_CODE"
          echo "=== Update Log ==="
          cat "$LOG_FILE"
          
          if [ $EXIT_CODE -ne 0 ]; then
            exit $EXIT_CODE
          fi
          
          # Get new build ID
          MANIFEST_FILE="/home/gh-runner/valheim/steamapps/appmanifest_892970.acf"
          if [ -f "$MANIFEST_FILE" ]; then
            NEW_BUILD=$(grep -oP '"buildid"\s+"\K[^"]+' "$MANIFEST_FILE")
            echo "new_build=$NEW_BUILD" >> $GITHUB_OUTPUT
            echo "New Valheim build: $NEW_BUILD"
          else
            echo "Error: Manifest file not found!"
            exit 1
          fi

      
      - name: Check if update occurred
        id: check_update
        run: |
          CURRENT="${{ steps.current_build.outputs.current_build }}"
          NEW="${{ steps.update_valheim.outputs.new_build }}"
          FORCE="${{ github.event.inputs.force_build }}"
          
          echo "Current build: $CURRENT"
          echo "New build: $NEW"
          echo "Force build: $FORCE"
          
          if [ "$CURRENT" == "$NEW" ] && [ "$FORCE" != "true" ]; then
            echo "No Valheim updates detected. Skipping build."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            if [ "$CURRENT" != "$NEW" ]; then
              echo "Valheim was updated from $CURRENT to $NEW"
            else
              echo "Force build enabled, proceeding despite no updates"
            fi
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Run GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v3.1.11
        with:
          useConfigFile: true
          configFilePath: GitVersion.yml

      - name: Display version
        shell: pwsh
        run: |
          echo "NuGetVersion: $env:GitVersion_SemVer"
          echo "SemVer: $env:GitVersion_SemVer"
          echo "FullSemVer: $env:GitVersion_FullSemVer"

      - name: Sync managed references
        if: steps.check_update.outputs.updated == 'true'
        run: |
          dotnet run tools/sync-managed.cs \
            --managedPath /home/gh-runner/valheim/valheim_Data/Managed \
            --outDir lib/net46
      
      - name: Update nuspec and pack
        if: steps.check_update.outputs.updated == 'true'
        run: |
          VERSION="${{ steps.gitversion.outputs.nuGetVersionV2 }}"
          sed "s/<version>.*<\/version>/<version>$VERSION<\/version>/" template.nuspec > Valheim.Managed.nuspec
          sed -i '/<\/metadata>/a\  <files>\n    <file src="lib/net46/**" target="lib/net46" />\n  </files>' Valheim.Managed.nuspec
          dotnet pack -p:NuspecFile=Valheim.Managed.nuspec -o .
      
      - name: Upload NuGet artifact
        if: steps.check_update.outputs.updated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: '*.nupkg'
      
      - name: Create Release
        if: steps.check_update.outputs.updated == 'true' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: '*.nupkg'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
