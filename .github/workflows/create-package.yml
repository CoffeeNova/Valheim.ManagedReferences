name: Pack Managed References

on:
  push:
    branches:
        - main
    tags:
        - 'v*'
  pull_request:
    branches:
        - main
  # schedule:
    # - cron: '0 */1 * * *'  # every hour
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no Valheim updates'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: self-hosted
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Get current build ID
        id: current_build
        run: |
          MANIFEST_FILE="/home/gh-runner/valheim/steamapps/appmanifest_892970.acf"
          if [ -f "$MANIFEST_FILE" ]; then
            CURRENT_BUILD=$(grep -oP '(?<="buildid"\s{4}").*(?=")' "$MANIFEST_FILE" || echo "0")
            echo "current_build=$CURRENT_BUILD" >> $GITHUB_OUTPUT
            echo "Current Valheim build: $CURRENT_BUILD"
          else
            echo "current_build=0" >> $GITHUB_OUTPUT
            echo "No existing installation found"
          fi
      
      - name: Update Valheim
        id: update_valheim
        run: |
          LOG_FILE="/tmp/valheim_update_${{ github.run_number }}.log"
          
          echo "Updating Valheim..."
          steamcmd +@sSteamCmdForcePlatformType windows \
            +login ${{ secrets.STEAM_USERNAME }} \
            +force_install_dir /home/gh-runner/valheim \
            +app_update 892970 validate \
            +quit | tee "$LOG_FILE"
          
          echo "Valheim update completed"
          echo "=== Update Log ==="
          cat "$LOG_FILE"
          
          # Get new build ID
          MANIFEST_FILE="/home/gh-runner/valheim/steamapps/appmanifest_892970.acf"
          NEW_BUILD=$(grep -oP '(?<="buildid"\s{4}").*(?=")' "$MANIFEST_FILE")
          echo "new_build=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "New Valheim build: $NEW_BUILD"
      
      - name: Check if update occurred
        id: check_update
        run: |
          CURRENT="${{ steps.current_build.outputs.current_build }}"
          NEW="${{ steps.update_valheim.outputs.new_build }}"
          FORCE="${{ github.event.inputs.force_build }}"
          
          echo "Current build: $CURRENT"
          echo "New build: $NEW"
          echo "Force build: $FORCE"
          
          if [ "$CURRENT" == "$NEW" ] && [ "$FORCE" != "true" ]; then
            echo "No Valheim updates detected. Skipping build."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            if [ "$CURRENT" != "$NEW" ]; then
              echo "Valheim was updated from $CURRENT to $NEW"
            else
              echo "Force build enabled, proceeding despite no updates"
            fi
            echo "updated=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup .NET 10
        if: steps.check_update.outputs.updated == 'true'
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '10.0.x'
      
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v3.1.11
        with:
          versionSpec: '6.0.x'

      - name: Run GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v3.1.11
        with:
          useConfigFile: true
          configFilePath: GitVersion.yml

      - name: Display version
        shell: pwsh
        run: |
          echo "NuGetVersion: $env:GitVersion_SemVer"
          echo "SemVer: $env:GitVersion_SemVer"
          echo "FullSemVer: $env:GitVersion_FullSemVer"

      - name: Sync managed references
        if: steps.check_update.outputs.updated == 'true'
        run: |
          dotnet run tools/sync-managed.cs \
            --managedPath /home/gh-runner/valheim/valheim_Data/Managed \
            --outDir lib/net46
      
      - name: Extract version from tag
        if: steps.check_update.outputs.updated == 'true'
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0-preview.${{ github.run_number }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"
      
      - name: Update nuspec and pack
        if: steps.check_update.outputs.updated == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # Create updated nuspec
          sed "s/<version>.*<\/version>/<version>$VERSION<\/version>/" template.nuspec > Valheim.Managed.nuspec
          
          # Add files section before </package>
          sed -i '/<\/metadata>/a\  <files>\n    <file src="lib/net46/**" target="lib/net46" />\n  </files>' Valheim.Managed.nuspec
          
          # Pack nuget
          dotnet pack -p:NuspecFile=Valheim.Managed.nuspec -o .
      
      - name: Upload NuGet artifact
        if: steps.check_update.outputs.updated == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: nuget-package
          path: '*.nupkg'
      
      - name: Create Release
        if: steps.check_update.outputs.updated == 'true' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: '*.nupkg'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
